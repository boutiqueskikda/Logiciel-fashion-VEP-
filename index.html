<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1, h2, h4 {
      color: #333;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .btn {
      background: #007bff;
      color: white;
      padding: 20px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #0056b3;
    }
    .section {
      display: none;
      margin-top: 30px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: right;
    }
    .active {
      display: block !important;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .barcode-label {
        page-break-inside: avoid;
        margin: 10px;
      }
    }
  </style>
</head>
<body>
<h1>ğŸ“‹ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± - BAZAR SERDANI</h1>
<div class="grid">
  <button class="btn" onclick="showSection('add')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
  <button class="btn" onclick="showSection('stock')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
  <button class="btn" onclick="showSection('sell')">ğŸ›’ Ø§Ù„Ø¨ÙŠØ¹</button>
  <button class="btn" onclick="showSection('return')">ğŸ” Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</button>
  <button class="btn" onclick="showSection('clients')">ğŸ‘¥ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</button>
  <button class="btn" onclick="showSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
  <button class="btn" onclick="showSection('print')">ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</button>
</div>
<!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
<div id="add" class="section">
  <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
  <form id="productForm">
    <label>ğŸ“¦ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:<br><input type="text" id="productName" required></label><br><br>
    <label>ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:<br><input type="number" id="buyPrice" required></label><br><br>
    <label>ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:<br><input type="number" id="sellPrice" required></label><br><br>
    <label>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©:<br><input type="number" id="quantity" required></label><br><br>
    <label>ğŸ”¢ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (ÙŠÙÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ØªØ±Ùƒ ÙØ§Ø±ØºÙ‹Ø§):<br><input type="text" id="barcode"></label><br><br>
    <button type="submit">ğŸ“¥ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
  </form>
  <p id="addProductMsg" style="color: green; font-weight: bold;"></p>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
<div id="stock" class="section">
  <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
  <div id="tableContainer"></div>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ¹ -->
<div id="sell" class="section">
  <h2>ğŸ›’ Ø§Ù„Ø¨ÙŠØ¹</h2>
  <input type="text" id="barcodeInput" placeholder="ğŸ” Ø£Ø¯Ø®Ù„ Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" oninput="searchProduct(this.value)" autofocus>
  <div id="saleInfo" style="display:none; background:#f9f9f9; border:1px solid #ccc; padding:10px; margin-top:10px;">
    <p><strong>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬:</strong> <span id="pName"></span></p>
    <p><strong>ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> <span id="pBuy"></span> DA</p>
    <p><strong>ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</strong> <input type="number" id="customSell" style="width:100px;"> DA</p>
    <p><strong>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> <span id="pQty"></span></p>
    <p><strong>ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­:</strong> <span id="profit"></span> DA</p>
    <button onclick="confirmSale()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</button>
  </div>
  <h4>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø´Ø±Ø§Ø¡</th>
        <th>Ø¨ÙŠØ¹</th>
        <th>Ø§Ù„Ø±Ø¨Ø­</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
      </tr>
    </thead>
    <tbody id="salesLog"></tbody>
  </table>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ -->
<div id="return" class="section">
  <h2>ğŸ” Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù†ØªØ¬</h2>
  <input type="text" id="returnSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" oninput="searchReturnProduct()">
  <div id="returnInfo" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px;">
    <p>ğŸ“¦ Ø§Ù„Ø§Ø³Ù…: <span id="returnName"></span></p>
    <p>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="returnQty"></span></p>
    <p>ğŸ›’ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="salesCount">0</span></p>
    <p>â†©ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: <span id="returnsCount">0</span></p>
    <p>ğŸ’¸ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹: <input type="number" id="returnSell" style="width:100px"> DA</p>
    <button onclick="confirmReturn()">â†©ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</button>
  </div>
  <div id="returnResult" style="margin-top:10px; font-weight:bold;"></div>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† -->
<div id="clients" class="section">
  <h2>ğŸ‘¥ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</h2>
  <div>
    <input type="text" id="custName" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
    <input type="text" id="custPhone" placeholder="ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="text" id="custAddress" placeholder="ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    <input type="number" id="custTotal" placeholder="ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
    <input type="number" id="custPaid" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
    <button onclick="addCustomer()">â• Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†</button>
  </div>
  <div id="customersList" style="margin-top: 20px;"></div>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div id="stats" class="section">
  <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
  <div style="margin-top: 10px;">
    <p>ğŸ’° Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØµØ§ÙÙŠ: <span id="dailyProfit">0</span> DA</p>
    <p>ğŸ“… Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: <span id="monthlyProfit">0</span> DA</p>
    <button onclick="resetDailyProfit()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
  </div>
</div>
<!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© -->
<div id="print" class="section">
  <h2>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>
  <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬:</label>
  <select id="printProduct">
    <option value="">-- Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ --</option>
  </select>
  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®:</label>
  <input type="number" id="printQty" min="1" value="1">
  <button onclick="generateBarcodes()">ğŸ“¦ ØªÙˆÙ„ÙŠØ¯</button>
  <button onclick="printBarcodes()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  <button onclick="document.getElementById('printArea').innerHTML=''">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
  <div id="printArea" style="margin-top: 20px;"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let products = JSON.parse(localStorage.getItem("products") || "[]");
let sales = JSON.parse(localStorage.getItem("sales") || "[]");
let currentProduct = null;
let returnProductIndex = -1;
// ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø©
function showSection(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  window.scrollTo(0, 0);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
  if(id === 'stock') renderStock();
  if(id === 'clients') loadCustomers();
  if(id === 'stats') updateStats();
  if(id === 'print') loadProductsForPrint();
  if(id === 'sell') loadSales();
}
function generateEAN13() {
  let base = Math.floor(Math.random() * 100000000000).toString().padStart(12, '0');
  let sum = 0;
  for (let i = 0; i < 12; i++) {
    sum += parseInt(base[i]) * (i % 2 === 0 ? 1 : 3);
  }
  let check = (10 - (sum % 10)) % 10;
  return base + check;
}
// Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById("productForm").addEventListener("submit", function(e) {
  e.preventDefault();
  let name = document.getElementById("productName").value.trim();
  let buy = parseFloat(document.getElementById("buyPrice").value);
  let sell = parseFloat(document.getElementById("sellPrice").value);
  let qty = parseInt(document.getElementById("quantity").value);
  let barcode = document.getElementById("barcode").value.trim() || generateEAN13();
  let product = { name, buy, sell, qty, barcode };
  products.push(product);
  localStorage.setItem("products", JSON.stringify(products));
  document.getElementById("addProductMsg").textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!";
  this.reset();
});
// Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
function renderStock() {
  let html = `
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø´Ø±Ø§Ø¡</th>
          <th>Ø¨ÙŠØ¹</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th>
          <th>ğŸ—‘ï¸ Ø­Ø°Ù</th>
        </tr>
      </thead><tbody>`;
  products.forEach((p, i) => {
    html += `
      <tr>
        <td>${p.name}</td>
        <td>${p.buy} DA</td>
        <td>${p.sell} DA</td>
        <td>${p.qty}</td>
        <td>${p.barcode}</td>
        <td><button onclick="editProduct(${i})">âœï¸</button></td>
        <td><button onclick="deleteProduct(${i})">ğŸ—‘ï¸</button></td>
      </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("tableContainer").innerHTML = html;
}
function deleteProduct(i) {
  if (confirm("âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
    products.splice(i, 1);
    localStorage.setItem("products", JSON.stringify(products));
    renderStock();
  }
}
function editProduct(i) {
  const p = products[i];
  const name = prompt("ğŸ“¦ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", p.name);
  const buy = prompt("ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:", p.buy);
  const sell = prompt("ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:", p.sell);
  const qty = prompt("ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©:", p.qty);
  if (name && buy && sell && qty) {
    products[i] = {
      ...p,
      name,
      buy: parseFloat(buy),
      sell: parseFloat(sell),
      qty: parseInt(qty)
    };
    localStorage.setItem("products", JSON.stringify(products));
    renderStock();
  }
}
// Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ¹
function searchProduct(code) {
  const p = products.find(prod => prod.barcode === code || prod.name.includes(code));
  if (p) {
    currentProduct = p;
    document.getElementById("saleInfo").style.display = "block";
    document.getElementById("pName").textContent = p.name;
    document.getElementById("pBuy").textContent = p.buy;
    document.getElementById("customSell").value = p.sell;
    document.getElementById("pQty").textContent = p.qty;
    calculateProfit();
  } else {
    document.getElementById("saleInfo").style.display = "none";
    currentProduct = null;
  }
}
document.getElementById("customSell").oninput = calculateProfit;
function calculateProfit() {
  if (!currentProduct) return;
  const sell = parseFloat(document.getElementById("customSell").value);
  const profit = sell - currentProduct.buy;
  document.getElementById("profit").textContent = profit.toFixed(2);
}
function confirmSale() {
  if (!currentProduct) return;
  const sell = parseFloat(document.getElementById("customSell").value);
  const profit = sell - currentProduct.buy;
  const time = new Date().toLocaleString();
  const i = products.findIndex(p => p.barcode === currentProduct.barcode);
  if (products[i].qty <= 0) return alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ©!");
  products[i].qty -= 1;
  localStorage.setItem("products", JSON.stringify(products));
  sales.push({ name: currentProduct.name, buy: currentProduct.buy, sell, profit, time });
  localStorage.setItem("sales", JSON.stringify(sales));
  let dp = parseFloat(localStorage.getItem("dailyProfit") || "0");
  dp += profit;
  localStorage.setItem("dailyProfit", dp);
  alert("âœ… ØªÙ… Ø§Ù„Ø¨ÙŠØ¹!");
  currentProduct = null;
  document.getElementById("barcodeInput").value = "";
  document.getElementById("saleInfo").style.display = "none";
  loadSales();
}
function loadSales() {
  const tbody = document.getElementById("salesLog");
  tbody.innerHTML = "";
  sales.slice().reverse().forEach(s => {
    tbody.innerHTML += `
      <tr>
        <td>${s.name}</td>
        <td>${s.buy}</td>
        <td>${s.sell}</td>
        <td>${s.profit}</td>
        <td>${s.time}</td>
      </tr>`;
  });
}
// Ù‚Ø³Ù… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
function searchReturnProduct() {
  const val = document.getElementById("returnSearch").value.trim();
  const foundIndex = products.findIndex(p => p.barcode === val || p.name.includes(val));
  if (foundIndex !== -1) {
    const product = products[foundIndex];
    returnProductIndex = foundIndex;
    document.getElementById("returnName").innerText = product.name;
    document.getElementById("returnQty").innerText = product.qty;
    document.getElementById("returnSell").value = product.sell;
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª
    const salesCount = sales.filter(s => s.name === product.name).length;
    const returns = JSON.parse(localStorage.getItem("returns") || "{}");
    const returnsCount = returns[product.barcode] || 0;
    
    document.getElementById("salesCount").innerText = salesCount;
    document.getElementById("returnsCount").innerText = returnsCount;
    
    document.getElementById("returnInfo").style.display = "block";
  } else {
    document.getElementById("returnInfo").style.display = "none";
  }
}
function confirmReturn() {
  if (returnProductIndex === -1) return;
  const prod = products[returnProductIndex];
  const barcode = prod.barcode;
  const sellBack = parseFloat(document.getElementById("returnSell").value);
  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª
  const salesCount = sales.filter(s => s.name === prod.name).length;
  const returns = JSON.parse(localStorage.getItem("returns") || "{}");
  const returnsCount = returns[barcode] || 0;
  if (returnsCount >= salesCount) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª!");
    return;
  }
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
  prod.qty += 1;
  localStorage.setItem("products", JSON.stringify(products));
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ
  let dailyProfit = parseFloat(localStorage.getItem("dailyProfit") || "0");
  dailyProfit -= sellBack;
  localStorage.setItem("dailyProfit", dailyProfit);
  // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª
  returns[barcode] = returnsCount + 1;
  localStorage.setItem("returns", JSON.stringify(returns));
  // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„
  let logs = JSON.parse(localStorage.getItem("salesLog") || "[]");
  logs.unshift(`${new Date().toLocaleString()} - â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹ ${prod.name} - Ø®ØµÙ… ${sellBack.toFixed(2)} DA`);
  localStorage.setItem("salesLog", JSON.stringify(logs));
  document.getElementById("returnResult").innerText = `â†©ï¸ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ${prod.name} | -${sellBack.toFixed(2)} DA Ù…Ù† Ø§Ù„Ø±Ø¨Ø­ | Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª: ${returns[barcode]}/${salesCount}`;
  searchReturnProduct();
}
// Ù‚Ø³Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†
function loadCustomers() {
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  let html = "";
  customers.forEach((cust, i) => {
    const remaining = cust.total - cust.paid;
    html += `
      <div style="border:1px solid #ccc; margin:10px; padding:10px;">
        <strong>ğŸ‘¤ ${cust.name}</strong><br>
        ğŸ“ ${cust.phone}<br>
        ğŸ“ ${cust.address}<br>
        ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${cust.total} DA<br>
        ğŸ’µ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${cust.paid} DA<br>
        ğŸ§¾ Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ${remaining} DA<br>
        <button onclick="editCustomer(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteCustomer(${i})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        ${remaining > 0 ? `<button onclick="recoverDebt(${i})">ğŸ’µ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¯ÙŠÙ†</button>` : "âœ… Ù…ÙƒØªÙ…Ù„"}
      </div>
    `;
  });
  document.getElementById("customersList").innerHTML = html;
}
function addCustomer() {
  const name = document.getElementById("custName").value.trim();
  const phone = document.getElementById("custPhone").value.trim();
  const address = document.getElementById("custAddress").value.trim();
  const total = parseFloat(document.getElementById("custTotal").value);
  const paid = parseFloat(document.getElementById("custPaid").value);
  if (!name || isNaN(total) || isNaN(paid)) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  customers.push({ name, phone, address, total, paid });
  localStorage.setItem("customers", JSON.stringify(customers));
  loadCustomers();
}
function deleteCustomer(index) {
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  if (confirm("âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ")) {
    customers.splice(index, 1);
    localStorage.setItem("customers", JSON.stringify(customers));
    loadCustomers();
  }
}
function editCustomer(index) {
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  const c = customers[index];
  const name = prompt("âœï¸ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:", c.name);
  const phone = prompt("ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:", c.phone);
  const address = prompt("ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:", c.address);
  const total = parseFloat(prompt("ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:", c.total));
  const paid = parseFloat(prompt("ğŸ’µ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:", c.paid));
  if (!name || isNaN(total) || isNaN(paid)) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  customers[index] = { name, phone, address, total, paid };
  localStorage.setItem("customers", JSON.stringify(customers));
  loadCustomers();
}
function recoverDebt(index) {
  const customers = JSON.parse(localStorage.getItem("customers") || "[]");
  const c = customers[index];
  const remaining = c.total - c.paid;
  const amount = parseFloat(prompt("ğŸ’µ ÙƒÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¢Ù†ØŸ", remaining));
  if (isNaN(amount) || amount <= 0) return alert("Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");
  customers[index].paid += amount;
  if (customers[index].paid > customers[index].total) {
    customers[index].paid = customers[index].total;
  }
  localStorage.setItem("customers", JSON.stringify(customers));
  let dailyProfit = parseFloat(localStorage.getItem("dailyProfit") || "0");
  dailyProfit += amount;
  localStorage.setItem("dailyProfit", dailyProfit);
  loadCustomers();
}
// Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStats() {
  const daily = parseFloat(localStorage.getItem("dailyProfit") || "0");
  const monthly = daily * new Date().getDate(); // Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  document.getElementById("dailyProfit").innerText = daily.toFixed(2);
  document.getElementById("monthlyProfit").innerText = monthly.toFixed(2);
}
function resetDailyProfit() {
  if (confirm("â“ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠØŸ")) {
    localStorage.setItem("dailyProfit", "0");
    updateStats();
  }
}
// Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
function loadProductsForPrint() {
  const select = document.getElementById("printProduct");
  select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ --</option>';
  
  products.forEach(p => {
    let option = document.createElement("option");
    option.value = p.barcode;
    option.textContent = p.name;
    select.appendChild(option);
  });
}
function generateBarcodes() {
  const barcode = document.getElementById("printProduct").value;
  const qty = parseInt(document.getElementById("printQty").value);
  const container = document.getElementById("printArea");
  if (!barcode || qty < 1) {
    alert("â— Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ÙˆØ¹Ø¯Ø¯ ØµØ­ÙŠØ­");
    return;
  }
  const product = products.find(p => p.barcode === barcode);
  if (!product) {
    alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    return;
  }
  container.innerHTML = "";
  for (let i = 0; i < qty; i++) {
    const box = document.createElement("div");
    box.className = "barcode-label";
    box.style.border = "1px solid #000";
    box.style.textAlign = "center";
    box.style.padding = "2px";
    box.style.margin = "5px";
    box.style.display = "inline-block";
    box.style.width = "35mm";
    box.style.height = "20mm";
    box.style.overflow = "hidden";
    box.style.fontFamily = "Arial, sans-serif";
    box.style.boxSizing = "border-box";
    box.innerHTML = `
      <div style="font-weight:bold; font-size:10px; color:#2c3e50; margin-bottom:2px;">BAZAR SERDANI</div>
      <div style="margin:2px 0; font-size:9px; font-weight:bold;">Prix: ${formatPrice(product.sell)} DA</div>
      <div style="margin:1px 0 2px 0;">
        <svg class="barcode" data-code="${product.barcode}" style="display:block; margin:0 auto;"></svg>
      </div>
      <div style="font-size:7px; margin-top:2px; word-break: break-all;">${product.barcode}</div>
    `;
    container.appendChild(box);
  }
  document.querySelectorAll(".barcode").forEach(svg => {
    JsBarcode(svg, svg.dataset.code, {
      format: "CODE128",
      displayValue: false,
      width: 1.2,
      height: 20,
      margin: 2
    });
  });
}
function printBarcodes() {
  if (document.getElementById("printArea").children.length === 0) {
    alert("â— Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  window.print();
}
function formatPrice(p) {
  let s = Math.round(p).toString();
  return s.length > 3 ? s.slice(0, -3) + " " + s.slice(-3) : s;
}
// ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  loadSales();
  updateStats();
  loadProductsForPrint();
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Enter Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
  document.getElementById("returnSearch").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      searchReturnProduct();
    }
  });
});
</script>
</body>
</html>